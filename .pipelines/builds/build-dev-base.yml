name: $(Date:yyyyMMdd).$(Rev:.r)
resources:
  repositories:
  - repository: vmchooserlandscaping
    type: github
    name: vmchooser/landscaping
    endpoint: vmchooser
trigger:
  batch: true
  branches:
    include:
    - master
  paths:
    include:
    - /terraform/
    - /.pipelines/templates/tf*
stages:
- stage: Dev
  displayName: Build stage
  jobs:
  - job: Build_Shared
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-build.yml
      parameters:
        module: shared
        stage: shared
  - job: Build_Core
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-build.yml
      parameters:
        module: core
        stage: dev
  - job: Build_Aks
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-build.yml
      parameters:
        module: aks
        stage: dev
- stage: DeployDev
  displayName: Deploy Dev Environment
  dependsOn: Dev
  jobs:
  - job: Deploy_Shared_Core
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-deploy.yml
      parameters:
        varfile: ../environments/shared.tfvars
        stage: shared
        module: shared
  - job: Deploy_Dev_Core
    dependsOn: Deploy_Shared_Core
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-deploy.yml
      parameters:
        varfile: ../environments/dev.tfvars
        stage: dev
        module: core
  - job: Deploy_Dev_Aks
    dependsOn: Deploy_Dev_Core
    variables:
    - group: vmchooser
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: ../templates/tf-environment-deploy.yml
      parameters:
        varfile: ../environments/dev.tfvars
        stage: dev
        module: aks